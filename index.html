<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Rota Gerais - MG</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; display: flex; font-family: 'Segoe UI', Tahoma, sans-serif; height: 100vh; overflow: hidden; }
        
        /* Painel Lateral */
        .sidebar { 
            width: 380px; background: #f8f9fa; display: flex; flex-direction: column;
            border-right: 1px solid #ddd; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 1001;
        }

        .header { padding: 20px; background: #2c3e50; color: white; }
        .filters { padding: 15px; border-bottom: 1px solid #ddd; background: #fff; }
        
        /* Lista de Obras */
        .results-list { flex: 1; overflow-y: auto; padding: 10px; background: #f1f3f5; }
        .obra-card { 
            background: white; padding: 12px; margin-bottom: 10px; border-radius: 6px;
            border-left: 5px solid #27ae60; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: 0.2s;
        }
        .obra-card:hover { background: #eef2f7; transform: translateX(5px); }
        .obra-card strong { display: block; color: #2c3e50; font-size: 0.95em; margin-bottom: 4px; }
        .obra-card span { font-size: 0.8em; color: #666; display: block; }

        #map { flex: 1; position: relative; background: #000; }
        
        .filter-group { margin-bottom: 12px; }
        label { font-size: 0.7em; font-weight: bold; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        select, input { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; }

        /* Popup Estilizado */
        .custom-popup { min-width: 280px; font-family: 'Segoe UI', sans-serif; }
        .popup-tag { color: #e67e22; font-weight: bold; font-size: 0.85em; text-transform: uppercase; }
        .popup-title { font-size: 1.1em; display: block; margin: 4px 0; color: #222; }
        .popup-info-row { display: flex; justify-content: space-between; font-size: 0.85em; margin-top: 5px; }
        .valor-destaque { color: #27ae60; font-weight: bold; font-size: 1.05em; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="header">
            <h3 style="margin:0">üìç Rota Gerais</h3>
            <div id="status" style="font-size: 0.8em; margin-top: 5px; opacity: 0.8;">Carregando dados de MG...</div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label>Munic√≠pio</label>
                <select id="filtroMunicipio" onchange="aplicarFiltros()">
                    <option value="todos">Todos os Munic√≠pios</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Tipo de Obra</label>
                <select id="filtroTipo" onchange="aplicarFiltros()">
                    <option value="todos">Todos os Tipos</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Buscar Obra ou ID</label>
                <input type="text" id="buscaTexto" placeholder="Ex: Amplia√ß√£o ou ID..." oninput="aplicarFiltros()">
            </div>
        </div>

        <div class="results-list" id="listaObras"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. Limites Geogr√°ficos de Minas Gerais para travar o mapa
        const boundsMG = [
            [-23.0, -51.5], // Sudoeste
            [-14.0, -39.5]  // Nordeste
        ];

        const map = L.map('map', {
            maxBounds: boundsMG,
            maxBoundsViscosity: 1.0 
        }).setView([-18.5, -44.5], 7);

        // 2. Camada de Sat√©lite com zoom inteligente (evita tela cinza)
        const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri',
            maxNativeZoom: 18, // Sat√©lite real para aqui
            maxZoom: 22        // Leaflet estica a imagem at√© aqui
        }).addTo(map);

        // Camada h√≠brida para nomes de cidades e ruas
        L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-hybrid/{z}/{x}/{y}{r}.png', {
            opacity: 0.6,
            maxZoom: 22
        }).addTo(map);

        let geojsonLayer;
        let dadosCompletos = [];

        // 3. Carregamento dos Dados
        async function carregarDados() {
            try {
                const res = await fetch('Obras_Validadas.json');
                const data = await res.json();
                dadosCompletos = data.features;
                
                popularDropdowns(dadosCompletos);
                aplicarFiltros();
                
                document.getElementById('status').innerText = `${dadosCompletos.length} obras identificadas em MG`;
            } catch (e) {
                document.getElementById('status').innerText = "Erro ao carregar Obras_Validadas.json";
            }
        }

        function popularDropdowns(features) {
            const munSet = new Set(), tipoSet = new Set();
            features.forEach(f => {
                if(f.properties.municipio) munSet.add(f.properties.municipio);
                if(f.properties.tipo_obra) tipoSet.add(f.properties.tipo_obra);
            });

            const preencher = (id, conjunto) => {
                const el = document.getElementById(id);
                [...conjunto].sort().forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = opt.text = v;
                    el.add(opt);
                });
            };
            preencher('filtroMunicipio', munSet);
            preencher('filtroTipo', tipoSet);
        }

        function aplicarFiltros() {
            const mun = document.getElementById('filtroMunicipio').value;
            const tipo = document.getElementById('filtroTipo').value;
            const busca = document.getElementById('buscaTexto').value.toLowerCase();

            const filtrados = dadosCompletos.filter(f => {
                const p = f.properties;
                const matchMun = mun === "todos" || p.municipio === mun;
                const matchTipo = tipo === "todos" || p.tipo_obra === tipo;
                const matchBusca = p.obra.toLowerCase().includes(busca) || 
                                   String(p.id).toLowerCase().includes(busca);
                return matchMun && matchTipo && matchBusca;
            });

            renderizarMapa(filtrados);
            renderizarLista(filtrados);
        }

        function renderizarMapa(features) {
            if (geojsonLayer) map.removeLayer(geojsonLayer);
            
            geojsonLayer = L.geoJSON({type: "FeatureCollection", features: features}, {
                style: { color: "#00FF00", weight: 5, opacity: 0.9 },
                onEachFeature: (f, l) => {
                    const p = f.properties;
                    
                    // CORRE√á√ÉO: Limita casas decimais no Popup
                    const kmIni = Number(p.km_inicial).toFixed(3);
                    const kmFim = Number(p.km_final).toFixed(3);

                    l.bindPopup(`
                        <div class="custom-popup">
                            <span class="popup-tag">${p.tipo_obra}</span>
                            <strong class="popup-title">Obra: ${p.obra}</strong>
                            <span style="font-size: 0.9em; color: #555;">üìç <b>Munic√≠pio:</b> ${p.municipio}</span>
                            <hr style="border:0; border-top: 1px solid #eee; margin: 8px 0;">
                            <div style="font-size: 0.85em; margin-bottom: 8px;">
                                <b>Descri√ß√£o:</b> ${p.descricao}
                            </div>
                            <div class="popup-info-row">
                                <span><b>Rodovia:</b> ${p.rodovia}</span>
                                <span><b>Ano:</b> ${p.ano_obra}</span>
                            </div>
                            <div class="popup-info-row" style="align-items: center;">
                                <span><b>Trecho:</b> KM ${kmIni} ao ${kmFim}</span>
                                <span class="valor-destaque">${p.valor_obra}</span>
                            </div>
                        </div>
                    `);
                }
            }).addTo(map);

            if (features.length > 0) map.fitBounds(geojsonLayer.getBounds(), {padding: [30,30]});
        }

        function renderizarLista(features) {
            const lista = document.getElementById('listaObras');
            lista.innerHTML = "";
            features.forEach(f => {
                const p = f.properties;
                const card = document.createElement('div');
                card.className = 'obra-card';
                card.innerHTML = `
                    <strong>${p.obra}</strong>
                    <span>üìç ${p.municipio} | ${p.rodovia}</span>
                    <div style="display:flex; justify-content:space-between; margin-top:5px;">
                        <span style="font-weight:bold; color:#e67e22">${p.tipo_obra}</span>
                        <span style="color:#27ae60; font-weight:bold">${p.valor_obra}</span>
                    </div>
                `;
                card.onclick = () => {
                    const layer = geojsonLayer.getLayers().find(l => l.feature.properties.id === p.id);
                    if(layer) {
                        map.fitBounds(layer.getBounds());
                        layer.openPopup();
                    }
                };
                lista.appendChild(card);
            });
        }

        carregarDados();
    </script>
</body>
</html>