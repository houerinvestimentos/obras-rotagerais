<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rota Gerais - Mobile Dashboard</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* Layout Mobile-First */
        body { margin: 0; display: flex; flex-direction: column; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }
        
        /* No Celular: 45% para lista, 55% para mapa */
        .sidebar { width: 100%; height: 45vh; background: #f8f9fa; display: flex; flex-direction: column; z-index: 1001; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        #map { width: 100%; height: 55vh; background: #000; position: relative; }

        /* No Computador: Barra lateral e Mapa Lado a Lado */
        @media (min-width: 768px) {
            body { flex-direction: row; }
            .sidebar { width: 380px; height: 100vh; border-right: 1px solid #ddd; }
            #map { width: calc(100% - 380px); height: 100vh; }
        }

        .header { padding: 15px; background: #2c3e50; color: white; flex-shrink: 0; }
        .filters { padding: 10px; background: #fff; border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .results-list { flex: 1; overflow-y: auto; padding: 10px; background: #f1f3f5; }
        
        .obra-card { 
            background: white; padding: 12px; margin-bottom: 10px; border-radius: 6px;
            border-left: 5px solid #27ae60; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .filter-group { margin-bottom: 8px; }
        select, input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }

        /* Bot√£o GPS */
        .gps-button {
            position: absolute; bottom: 20px; right: 20px; z-index: 1000;
            background: #fff; border: none; width: 45px; height: 45px; border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); cursor: pointer; font-size: 20px;
        }

        /* Popup Estilizado */
        .custom-popup { min-width: 250px; }
        .popup-tag { color: #e67e22; font-weight: bold; font-size: 0.8em; text-transform: uppercase; }
        .popup-info-row { display: flex; justify-content: space-between; font-size: 0.85em; margin-top: 5px; }
        .valor-destaque { color: #27ae60; font-weight: bold; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="header">
            <h3 style="margin:0; font-size: 1.1em;">üìç Rota Gerais</h3>
            <div id="status" style="font-size: 0.7em; opacity: 0.8;">Carregando...</div>
        </div>
        <div class="filters">
            <div class="filter-group"><select id="filtroMunicipio" onchange="aplicarFiltros()"><option value="todos">Todos Munic√≠pios</option></select></div>
            <div class="filter-group"><input type="text" id="buscaTexto" placeholder="ID ou Nome..." oninput="aplicarFiltros()"></div>
        </div>
        <div class="results-list" id="listaObras"></div>
    </div>

    <div id="map">
        <button class="gps-button" onclick="focarGPS()" title="Minha Localiza√ß√£o">üéØ</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Configura√ß√£o do Mapa com travas de MG e Zoom
        const boundsMG = [[-23.0, -51.5], [-14.0, -39.5]];
        const map = L.map('map', { maxBounds: boundsMG, maxBoundsViscosity: 1.0 }).setView([-18.5, -44.5], 7);

        // Sat√©lite corrigido para evitar tela cinza
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Esri', maxNativeZoom: 18, maxZoom: 22
        }).addTo(map);

        let geojsonLayer, dadosCompletos = [], userMarker;

        // GPS em Tempo Real
        userMarker = L.circleMarker([0, 0], { radius: 8, fillColor: "#3498db", color: "#fff", weight: 2, fillOpacity: 1 }).addTo(map);

        function focarGPS() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(p => {
                    const pos = [p.coords.latitude, p.coords.longitude];
                    userMarker.setLatLng(pos);
                    map.setView(pos, 15);
                }, () => alert("Ative o GPS do celular para ver sua localiza√ß√£o."));
            }
        }

        if ("geolocation" in navigator) {
            navigator.geolocation.watchPosition(p => {
                userMarker.setLatLng([p.coords.latitude, p.coords.longitude]);
            }, null, { enableHighAccuracy: true });
        }

        // Carregar Dados
        async function carregar() {
            try {
                const res = await fetch('Obras_Validadas.json');
                const data = await res.json();
                dadosCompletos = data.features;
                popularDropdown(dadosCompletos);
                aplicarFiltros();
                document.getElementById('status').innerText = `${dadosCompletos.length} obras identificadas`;
            } catch (e) { document.getElementById('status').innerText = "Erro ao ler JSON"; }
        }

        function popularDropdown(features) {
            const munSet = new Set();
            features.forEach(f => munSet.add(f.properties.municipio));
            const select = document.getElementById('filtroMunicipio');
            [...munSet].sort().forEach(m => { let opt = document.createElement('option'); opt.value = opt.text = m; select.add(opt); });
        }

        function aplicarFiltros() {
            const mun = document.getElementById('filtroMunicipio').value;
            const busca = document.getElementById('buscaTexto').value.toLowerCase();
            const filtrados = dadosCompletos.filter(f => {
                const p = f.properties;
                return (mun === "todos" || p.municipio === mun) && (p.obra.toLowerCase().includes(busca) || String(p.id).includes(busca));
            });
            renderMapa(filtrados);
            renderLista(filtrados);
        }

        function renderMapa(features) {
            if (geojsonLayer) map.removeLayer(geojsonLayer);
            geojsonLayer = L.geoJSON({type: "FeatureCollection", features: features}, {
                style: { color: "#00FF00", weight: 5, opacity: 0.9 },
                onEachFeature: (f, l) => {
                    const p = f.properties;
                    // FIX: Precis√£o de 3 casas decimais
                    const ini = Number(p.km_inicial).toFixed(3);
                    const fim = Number(p.km_final).toFixed(3);
                    l.bindPopup(`
                        <div class="custom-popup">
                            <span class="popup-tag">${p.tipo_obra}</span><br>
                            <strong>${p.obra}</strong><br>
                            <small>üìç ${p.municipio}</small>
                            <hr style="border:0; border-top:1px solid #eee; margin:8px 0;">
                            <div style="font-size:0.85em; margin-bottom:5px;"><b>Descri√ß√£o:</b> ${p.descricao}</div>
                            <div class="popup-info-row"><span><b>Rodovia:</b> ${p.rodovia}</span><span><b>Ano:</b> ${p.ano_obra}</span></div>
                            <div class="popup-info-row"><span><b>Trecho:</b> KM ${ini} ao ${fim}</span><span class="valor-destaque">${p.valor_obra}</span></div>
                        </div>
                    `);
                }
            }).addTo(map);
            if (features.length > 0) map.fitBounds(geojsonLayer.getBounds(), {padding: [30,30]});
        }

        function renderLista(features) {
            const lista = document.getElementById('listaObras');
            lista.innerHTML = "";
            features.forEach(f => {
                const p = f.properties;
                const card = document.createElement('div');
                card.className = 'obra-card';
                card.innerHTML = `<strong>${p.obra}</strong><span>üìç ${p.municipio} | ${p.rodovia}</span>
                <div class="popup-info-row"><span style="color:#e67e22; font-weight:bold">${p.tipo_obra}</span><span class="valor-destaque">${p.valor_obra}</span></div>`;
                card.onclick = () => {
                    const layer = geojsonLayer.getLayers().find(l => l.feature.properties.id === p.id);
                    if(layer) { map.fitBounds(layer.getBounds()); layer.openPopup(); }
                };
                lista.appendChild(card);
            });
        }
        carregar();
    </script>
</body>
</html>